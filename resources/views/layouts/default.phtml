<?php

use Fisharebest\Webtrees\View;
use Fisharebest\Webtrees\Registry;
use Fisharebest\Webtrees\I18N;
use Fisharebest\Webtrees\Module\ModuleThemeInterface;
use Fisharebest\Webtrees\Module\ModuleGlobalInterface;
use Fisharebest\Webtrees\Services\ModuleService;

// --- 1. SETUP ---
$wp_data = \Webtrees\Modules\WebtreesSvajana\WebtreesSvajana::getWpHeaderData();
$tree = $tree ?? null;

// Ensure $theme is defined
$theme = $theme ?? Registry::container()->get(ModuleThemeInterface::class);

// ============================================================================
// WEBTREES MENU GENERATION LOGIC
// ============================================================================
if (!function_exists('render_webtrees_menu')) {
    function render_webtrees_menu(array $menu_items, $theme, $tree, bool $is_submenu = false): string {
        $html = '';
        foreach ($menu_items as $item) {
            $submenus = $item->getSubmenus();
            $has_children = !empty($submenus);
            
            $li_classes = $is_submenu ? '' : 'nav-item';
            $a_classes  = $is_submenu ? 'dropdown-item' : 'nav-link';
            if ($has_children) $li_classes .= ' menu-item-has-children';
            
            // Add item class to li if available
            if ($item->getClass()) {
                $li_classes .= ' ' . $item->getClass();
            }

            $html .= '<li class="' . $li_classes . '">';
            
            // Build attributes string for the anchor tag
            $attrs = '';
            foreach ($item->getAttrs() as $key => $value) {
                $attrs .= ' ' . e($key) . '="' . e($value) . '"';
            }
            
            $html .= '<a href="' . e($item->getLink()) . '" class="' . $a_classes . '"' . $attrs . '>' . e($item->getLabel());
            
            if ($has_children) {
                 $html .= '<span class="dropdown-nav-toggle"><span class="kadence-svg-iconset"><svg class="kadence-svg-icon kadence-arrow-down-svg" fill="currentColor" width="12" height="12" viewBox="0 0 24 24"><path d="M5.293 9.707l6 6c0.391 0.391 1.024 0.391 1.414 0l6-6c0.391-0.391 0.391-1.024 0-1.414s-1.024-0.391-1.414 0l-5.293 5.293-5.293-5.293c-0.391-0.391-1.024-0.391-1.414 0s-0.391 1.024 0 1.414z"/></svg></span></span>';
            }
            $html .= '</a>';
            
            if ($has_children) {
                $html .= '<ul class="sub-menu">' . render_webtrees_menu($submenus, $theme, $tree, true) . '</ul>';
            }
            $html .= '</li>';
        }
        return $html;
    }
}

$primary_navigation = '';
$secondary_navigation = '';

if ($theme) {
    $primary_navigation   = render_webtrees_menu($theme->genealogyMenu($tree), $theme, $tree, false);
    $secondary_navigation = render_webtrees_menu($theme->userMenu($tree), $theme, $tree, false);
}
?>
<!doctype html>
<html dir="<?= I18N::direction() ?>" lang="<?= I18N::languageTag() ?>" class="no-js">
<head>
    <meta charset="UTF-8">
    <meta name="csrf" content="<?= e(csrf_token()) ?>">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <title><?= $title ?? 'Webtrees' ?></title>
    <?php
    echo View::stack('head');
    echo '<link rel="stylesheet" href="' . e(asset('css/vendor.min.css')) . '">';
    echo View::stack('styles');
    
    // Load theme stylesheets using the theme's stylesheets() method
    if (method_exists($theme, 'stylesheets')) {
        foreach ($theme->stylesheets() as $stylesheet) {
            echo '<link rel="stylesheet" href="' . e($stylesheet) . '">';
        }
    }
    
    // Load global module head content (includes Font Awesome fonts and other module styles)
    echo Registry::container()->get(ModuleService::class)
        ->findByInterface(ModuleGlobalInterface::class)
        ->map(static fn (ModuleGlobalInterface $module): string => $module->headContent())
        ->implode('');
    ?>
</head>
<body class="wp-theme-kadence wp-child-theme-kadence-child <?= e($body_class ?? '') ?>">
    <div id="wrapper" class="site wp-site-blocks" style="min-height: 100vh; display: flex; flex-direction: column;">
        
        <?php
        echo View::make('svajana::layouts/_menu', [
            'wp_data'              => $wp_data,
            'primary_navigation'   => $primary_navigation,
            'secondary_navigation' => $secondary_navigation
        ]);
        ?>

        <!-- HERO SECTION -->
        <div class="wt-hero-section">
             <div class="wt-hero-background"></div>
             <div class="wt-hero-overlay"></div>
        </div>

        <div class="wt-main-wrapper" style="flex: 1;">
            <main id="inner-wrap" class="wrap kt-clear" role="main">
                <div id="primary" class="content-area">
                    <div class="content-container site-container">
                        <div id="main" class="site-main">
                            <div class="content-wrap">
                                <article class="entry content-bg">
                                    <div class="entry-content-wrap">
                                        <div class="kb-row-layout-wrap">
                                            <div class="wt-main-container">
                                                <?= $content ?? '' ?>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <?php
        echo View::make('svajana::layouts/_footer', [
            'wp_data' => $wp_data
        ]);
        ?>

        <script src="<?= e(asset('js/vendor.min.js')) ?>"></script>
        <script src="<?= e(asset('js/webtrees.min.js')) ?>"></script>
        <?php if (method_exists($theme, 'assetUrl')): ?>
        <script src="<?= e($theme->assetUrl('js/theme.js')) ?>"></script>
        <?php endif; ?>
        <?php echo View::stack('javascript'); ?>
        
        <?php
        // Load body content from all ModuleGlobalInterface modules (including dropdown-toggle.js)
        echo Registry::container()->get(ModuleService::class)
            ->findByInterface(ModuleGlobalInterface::class)
            ->map(static fn (ModuleGlobalInterface $module): string => $module->bodyContent())
            ->implode('');
        ?>
    </div>
</body>
</html>