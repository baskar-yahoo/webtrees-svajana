<?php

/** 
 * PARTIAL: Header & Navigation
 * Layout: Transparent to Sticky (Scroll Effect)
 */

// Helper for WP Menus
if (!function_exists('render_wp_menu_recursive')) {
    function render_wp_menu_recursive(array $items)
    {
        $html = '';
        foreach ($items as $item) {
            $has_children = !empty($item['children']);

            // Determine if active (simplistic check, usually WP handles classes)
            // If classes array contains 'current-menu-item', add active class
            $active = false;
            if (!empty($item['classes']) && is_array($item['classes'])) {
                if (in_array('current-menu-item', $item['classes']) || in_array('current_page_item', $item['classes'])) {
                    $active = true;
                }
            }

            $li_classes = 'nav-item ' . ($has_children ? 'menu-item-has-children' : '') . ($active ? ' current-menu-item' : '');

            $html .= '<li class="' . $li_classes . '">';
            $html .= '<a href="' . e($item['url']) . '" class="nav-link" ' . (!empty($item['target']) ? 'target="' . e($item['target']) . '"' : '') . '>';
            $html .= e($item['title']);
            if ($has_children) {
                $html .= '<span class="dropdown-nav-toggle"><span class="kadence-svg-iconset"><svg class="kadence-svg-icon kadence-arrow-down-svg" fill="currentColor" width="12" height="12" viewBox="0 0 24 24"><path d="M5.293 9.707l6 6c0.391 0.391 1.024 0.391 1.414 0l6-6c0.391-0.391 0.391-1.024 0-1.414s-1.024-0.391-1.414 0l-5.293 5.293-5.293-5.293c-0.391-0.391-1.024-0.391-1.414 0s-0.391 1.024 0 1.414z"/></svg></span></span>';
            }
            $html .= '</a>';
            if ($has_children) {
                $html .= '<ul class="sub-menu">' . render_wp_menu_recursive($item['children']) . '</ul>';
            }
            $html .= '</li>';
        }
        return $html;
    }
}
?>
<style>
    :root {
        --global-palette1: <?= $wp_data['primary_color'] ?>;
        /* Navy */
        --global-palette2: <?= $wp_data['secondary_color'] ?>;
        /* Orange */
        --global-palette8: <?= $wp_data['footer_bg'] ?>;

        /* Typography from DB */
        --brand-font-size: <?= $wp_data['brand_font_css'] ?>;
        --menu-font-size: <?= $wp_data['menu_font_css'] ?>;
    }
</style>

<header id="masthead" class="site-header" role="banner">

    <!-- DESKTOP: UTILITY BAR (Top of Stack) -->
    <div class="top-row desktop-only utility-bar">
        <div class="site-container">
            <?php if (!empty($secondary_navigation)): ?>
                <nav class="secondary-navigation">
                    <ul class="menu menu-horizontal" style="justify-content: flex-end; margin:0; list-style:none; display:flex; gap:15px;">
                        <?= $secondary_navigation ?>
                    </ul>
                </nav>
            <?php endif; ?>
        </div>
    </div>

    <!-- MAIN HEADER AREA -->
    <div class="main-header-area">
        <div class="site-container" style="display: flex; justify-content: space-between; align-items: center;">

            <!-- LEFT: BRANDING -->
            <div class="site-branding">
                <a href="<?= e($wp_data['siteurl'] ?? '/') ?>" class="brand" style="text-decoration: none; display: flex; align-items: center; gap: 10px;">
                    <?php if (!empty($wp_data['custom_logo_url'])): ?>
                        <!-- Standard Logo (visible by default) -->
                        <img src="<?= e($wp_data['custom_logo_url']) ?>"
                            alt="Logo"
                            class="custom-logo standard-logo"
                            style="max-height: 80px; width: auto;" />
                    <?php endif; ?>

                    <?php if (!empty($wp_data['sticky_logo_url'])): ?>
                        <!-- Sticky Logo (hidden by default, shown when header is sticky) -->
                        <img src="<?= e($wp_data['sticky_logo_url']) ?>"
                            alt="Sticky Logo"
                            class="custom-logo sticky-logo"
                            style="max-height: 80px; width: auto; display: none;" />
                    <?php endif; ?>

                    <!-- Always show site title next to logo if Kadence is configured that way, or just as fallback -->
                    <span class="site-title"><?= e($wp_data['blogname']) ?></span>
                </a>
            </div>

            <!-- RIGHT: STACKED NAVIGATION -->
            <div class="header-right-stack desktop-only" style="display: flex; flex-direction: column; align-items: flex-end; gap: 15px;">

                <!-- Row 2: WordPress Main Menu -->
                <nav class="main-navigation">
                    <ul class="menu menu-horizontal">
                        <?php
                        if (!empty($wp_data['wp_menu_items'])) {
                            echo render_wp_menu_recursive($wp_data['wp_menu_items']);
                        } else {
                            // Fallback
                            echo '<li><a href="/">Home</a></li>';
                            echo '<li><a href="/about/">About</a></li>';
                        }
                        ?>
                    </ul>
                </nav>

                <!-- Row 3: Webtrees App Menu -->
                <nav class="webtrees-navigation">
                    <ul class="menu menu-horizontal" style="display: flex; gap: 20px; margin: 0; list-style: none; font-size: 0.85rem;">
                        <?= $primary_navigation ?>
                    </ul>
                </nav>

            </div>

            <!-- MOBILE HAMBURGER TRIGGER -->
            <div class="mobile-header-controls mobile-only">
                <button class="mobile-menu-toggle" aria-label="Open Menu">
                    <span class="hamburger-icon">☰</span>
                </button>
            </div>

        </div>
    </div>

    <!-- MOBILE DRAWER (Off-Canvas) -->
    <div id="mobile-drawer" class="mobile-drawer-container mobile-only">
        <div class="mobile-drawer-backdrop"></div>
        <div class="mobile-drawer-content">
            <div class="drawer-header">
                <span class="drawer-title">Menu</span>
                <button class="drawer-close" aria-label="Close Menu">×</button>
            </div>
            <div class="drawer-scrollable">
                <nav class="mobile-nav">
                    <ul class="menu">
                        <?php
                        if (!empty($wp_data['wp_menu_items'])) {
                            echo render_wp_menu_recursive($wp_data['wp_menu_items']);
                        }
                        ?>
                        <hr style="margin: 10px 0; border:0; border-top:1px solid #eee;" />
                        <?= $primary_navigation ?>
                        <hr style="margin: 10px 0; border:0; border-top:1px solid #eee;" />
                        <?= $secondary_navigation ?>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</header>